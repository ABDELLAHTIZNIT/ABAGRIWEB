<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AB AGRIWEB</title>
<style>
:root{--bg:#0f172a;--text:#e2e8f0;--accent:#22c55e}
*{box-sizing:border-box}
body{
  margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:linear-gradient(180deg,#0f172a,#1e293b);
  color:var(--text);min-height:100vh;display:grid;place-items:center;padding:20px;transition:background .2s ease
}
.card{width:min(420px,92vw);background:transparent;border:none;box-shadow:none;padding:22px}
h1{margin:0 0 12px;color:var(--accent);text-align:center;text-shadow:0 2px 8px rgba(0,0,0,.6)}
.banner{margin:-4px -4px 14px -4px}
.banner img{width:100%;border-radius:12px;border:1px solid rgba(30,41,59,.6);box-shadow:0 8px 24px rgba(0,0,0,.45)}
label{display:block;margin:10px 0 6px;color:#e5eefc;text-shadow:0 2px 8px rgba(0,0,0,.6)}
.input{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(51,65,85,.8);background:#091227e6;color:#e2e8f0;box-shadow:0 6px 16px rgba(0,0,0,.35)}
.field{position:relative}
.eye{position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer;filter:drop-shadow(0 2px 6px rgba(0,0,0,.6))}
.btn{width:100%;margin-top:12px;padding:12px;border-radius:10px;border:1px solid var(--accent);background:var(--accent);color:#0b1220;font-weight:700;cursor:pointer;text-align:center;display:block;box-shadow:0 10px 20px rgba(0,0,0,.35)}
a{display:block;text-align:center;margin-top:10px;color:#c7e2ff;text-decoration:none;text-shadow:0 2px 8px rgba(0,0,0,.6)}
.hidden{display:none!important}

/* Recovery modal */
.modal-wrap{position:fixed;inset:0;display:grid;place-items:center;z-index:60}
.modal-wrap:not(.show){display:none}
.modal-bg{position:absolute;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px)}
.modal{position:relative;width:min(520px,92vw);background:#0b1220;border:1px solid #243046;border-radius:14px;padding:16px;box-shadow:0 18px 40px rgba(0,0,0,.45)}
.modal h3{margin:0 0 10px}
.row{display:flex;gap:10px;flex-wrap:wrap}
.small{font-size:12px;opacity:.85}
.btn.inline{width:auto;display:inline-block}
.tabbar{display:flex;gap:8px;margin:8px 0 12px}
.tabbar .btn{width:auto;padding:8px 10px}
</style>
</head>
<body>
  <div class="card">
    <!-- ÿ¥ÿπÿßÿ± ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ŸÖŸÜ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ -->
    <div id="loginLogoWrap" class="banner hidden"><img id="loginLogoImg" alt=""></div>
    <!-- ÿ®ÿßŸÜÿ± ÿßÿÆÿ™Ÿäÿßÿ±Ÿä ŸÅŸàŸÇ ÿßŸÑÿ≠ŸÇŸàŸÑ -->
    <div class="banner hidden" id="loginBanner"><img id="loginBannerImg" alt=""></div>
    <!-- ÿßÿ≥ŸÖ ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿ•ŸÜ ŸÑŸÖ ŸäŸàÿ¨ÿØ ÿ¥ÿπÿßÿ± -->
    <h1 id="appTitle" class="hidden">AB AGRIWEB</h1>

    <label>Username</label>
    <input id="u" class="input" placeholder="Enter your username"/>

    <label>Password</label>
    <div class="field">
      <input id="p" type="password" class="input" placeholder="Enter your password"/>
      <span class="eye" onclick="togglePass()">üëÅÔ∏è</span>
    </div>

    <a href="main.html" class="btn" id="loginBtn">Login</a>
    <a href="#" id="forgotLink">Forgot password?</a>
  </div>

<!-- Recovery Modal -->
<div id="recoveryModal" class="modal-wrap">
  <div class="modal-bg" onclick="closeRecovery()"></div>
  <div class="modal">
    <h3>Account recovery</h3>
    <div class="small" id="recoveryHints"></div>
    <div class="tabbar">
      <button class="btn inline" onclick="switchRecTab('code')">Code</button>
      <button class="btn inline" onclick="switchRecTab('qa')">Question secr√®te</button>
    </div>

    <div id="recTabCode">
      <label>Recovery code (6 digits)</label>
      <input id="rec_code" class="input" placeholder="Ex: 123456">
      <button class="btn" onclick="tryCode()">V√©rifier &amp; ouvrir</button>
    </div>

    <div id="recTabQA" class="hidden">
      <div id="qa_wrap">
        <label id="qa_question">Question</label>
        <input id="qa_answer" class="input" placeholder="Votre r√©ponse">
        <button class="btn" onclick="tryQA()">V√©rifier &amp; ouvrir</button>
      </div>
      <div id="qa_empty" class="small hidden">Question secr√®te ÿ∫Ÿäÿ± ŸÖŸÅÿπŸëŸÑÿ© ŸÅŸä ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™.</div>
    </div>

    <div class="small" style="margin-top:10px" id="recoveryContact"></div>

    <div style="text-align:right;margin-top:10px">
      <button class="btn inline" onclick="closeRecovery()">Fermer</button>
    </div>
  </div>
</div>

<script>
const LS_APP='ab_appcfg', LS_IMG='ab_appimg', LS_SEC='ab_security';
function loadCfg(){try{return JSON.parse(localStorage.getItem(LS_APP)||'{}')}catch{return{}}}
function loadImgs(){try{return JSON.parse(localStorage.getItem(LS_IMG)||'{}')}catch{return{}}}
function loadSec(){try{return JSON.parse(localStorage.getItem(LS_SEC)||'{}')}catch{return{}}}

(function init(){
  const cfg=loadCfg();
  if(cfg.appTitle){ document.title=cfg.appTitle; }

  const imgs=loadImgs();

  // ÿ¥ÿπÿßÿ± ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ (PNG/GIF) ÿ£Ÿà fallback ŸÑŸÑÿßÿ≥ŸÖ
  if( (imgs.logo && /^data:image\/(png|gif);/i.test(imgs.logo)) ||
      (typeof imgs.logo==='string' && /\.(png|gif)(\?|#|$)/i.test(imgs.logo)) ){
    const wrap=document.getElementById('loginLogoWrap');
    const img=document.getElementById('loginLogoImg');
    img.src=imgs.logo; wrap.classList.remove('hidden');
  } else {
    document.getElementById('appTitle').classList.remove('hidden');
  }

  // ÿ®ÿßŸÜÿ± ÿßŸÑÿØÿÆŸàŸÑ
  if( (imgs.login && /^data:image\/(png|gif);/i.test(imgs.login)) ||
      (typeof imgs.login==='string' && /\.(png|gif)(\?|#|$)/i.test(imgs.login)) ){
    const wrap=document.getElementById('loginBanner');
    const img=document.getElementById('loginBannerImg');
    img.src=imgs.login; wrap.classList.remove('hidden');
  }

  // ÿÆŸÑŸÅŸäÿ© ŸÉÿßŸÖŸÑÿ©
  if( (imgs.loginBg && /^data:image\/(png|gif);/i.test(imgs.loginBg)) ||
      (typeof imgs.loginBg==='string' && /\.(png|gif)(\?|#|$)/i.test(imgs.loginBg)) ){
    document.body.style.backgroundImage=`url('${imgs.loginBg}')`;
    document.body.style.backgroundSize='cover';
    document.body.style.backgroundPosition='center';
    document.body.style.backgroundRepeat='no-repeat';
  } else {
    document.body.style.background='linear-gradient(180deg,#0f172a,#1e293b)';
  }
})();

function togglePass(){ const i=document.getElementById('p'); i.type=i.type==='password'?'text':'password'; }
function login(){ const url=new URL('main.html',window.location.href).toString(); window.location.href=url; }

document.addEventListener('DOMContentLoaded',()=>{
  const btn=document.getElementById('loginBtn');
  if(btn) btn.addEventListener('click',(e)=>{ if(!btn.getAttribute('href')){ e.preventDefault(); login(); } });
  document.getElementById('forgotLink').addEventListener('click', (e)=>{e.preventDefault(); openRecovery();});
});

/* ==== Recovery flow (local) ==== */
function openRecovery(){
  const sec=loadSec();
  // hints (email/phone ÿ¢ÿÆÿ± ÿ£ÿ±ŸÇÿßŸÖ)
  const email=sec.email||'', phone=sec.phone||'';
  const emailHint=email?`Email: ${email.replace(/(.{2}).+(@.+)/,'$1***$2')}`:'Email non configur√©';
  const phoneHint=phone?`T√©l√©phone: ****${phone.slice(-4)}`:'T√©l√©phone non configur√©';
  document.getElementById('recoveryHints').textContent='Conseil: ÿßÿ≥ÿ™ÿπŸÖŸÑ ÿßŸÑÿ±ŸÖÿ≤ ÿ£Ÿà ÿ£ÿ¨ÿ® ÿπŸÑŸâ ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿßŸÑÿ≥ÿ±Ÿä.';
  document.getElementById('recoveryContact').textContent=`${emailHint} | ${phoneHint}`;

  // question secr√®te
  const hasQ=!!sec.question;
  document.getElementById('qa_wrap').classList.toggle('hidden', !hasQ);
  document.getElementById('qa_empty').classList.toggle('hidden', hasQ);
  if(hasQ) document.getElementById('qa_question').textContent=sec.question;

  switchRecTab('code');
  document.getElementById('recoveryModal').classList.add('show');
}
function closeRecovery(){ document.getElementById('recoveryModal').classList.remove('show'); }
function switchRecTab(tab){
  document.getElementById('recTabCode').classList.toggle('hidden', tab!=='code');
  document.getElementById('recTabQA').classList.toggle('hidden', tab!=='qa');
}
function tryCode(){
  const code=(document.getElementById('rec_code').value||'').trim();
  const sec=loadSec();
  if(code && sec.recoveryCode && code===String(sec.recoveryCode)){
    login();
  }else{
    alert('Code invalide ou non configur√©.');
  }
}
function tryQA(){
  const ans=(document.getElementById('qa_answer').value||'').trim().toLowerCase();
  const sec=loadSec();
  if(!sec.answerHash){ alert('Question secr√®te ÿ∫Ÿäÿ± ŸÖŸÅÿπŸÑÿ©.'); return; }
  if(hashLite(ans)===sec.answerHash){ login(); } else { alert('R√©ponse incorrecte.'); }
}
// hash ÿ®ÿ≥Ÿäÿ∑ ÿ∫Ÿäÿ± ÿ¢ŸÖŸÜ (ŸÑŸÑÿ™ÿ¨ÿ±ÿ®ÿ© ŸÅŸÇÿ∑)
function hashLite(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0}return String(h)}
</script>
</body>
</html>
