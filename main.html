<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>AB AGRIWEB - Dashboard</title>
<style>
  :root{
    --bg:#0f172a; --panel:#0b1220; --text:#e2e8f0; --accent:#22c55e; --border:#243046;
    --tile:#0c1526; --tileIcon:#0f1a2e;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:linear-gradient(180deg,var(--bg),#1e293b); color:var(--text);
    height:100vh; overflow-x:hidden;
  }
  .hidden{display:none !important;}

  /* Header */
  header{
    position:sticky; top:0; z-index:20;
    display:flex; align-items:center; justify-content:space-between;
    background:var(--panel); padding:12px 18px; border-bottom:1px solid var(--border);
    box-shadow:0 2px 12px rgba(0,0,0,.25);
  }
  .menu-btn{ background:none; border:none; color:var(--text); font-size:24px; cursor:pointer; }
  .title{ font-weight:800; color:var(--accent); letter-spacing:.5px }

  /* Sidebar */
  .sidebar{
    position:fixed; top:0; left:-260px; width:260px; height:100%;
    background:#0b1220; border-right:1px solid var(--border);
    transition:left .35s ease; display:flex; flex-direction:column; padding-top:56px;
    box-shadow:4px 0 20px rgba(0,0,0,.4); z-index:15;
  }
  .sidebar.active{ left:0; }
  .side-header{
    position:absolute; top:0; left:0; right:0; height:56px;
    display:flex; align-items:center; gap:10px; padding:0 14px;
    border-bottom:1px solid #1e293b; background:#0b1220;
  }
  .close-btn{
    width:36px; height:36px; border:none; border-radius:8px; cursor:pointer;
    background:#111827; color:#e2e8f0; font-size:22px; line-height:1;
  }
  .close-btn:hover{ background:#0f172a; }
  .side-header span{ font-weight:700; color:#cbd5e1 }

  .sidebar a{
    display:flex; align-items:center; gap:10px; padding:14px 24px;
    color:var(--text) !important; text-decoration:none; border-bottom:1px solid #1e293b;
  }
  .sidebar a:hover{ background:var(--accent); color:#0b1220 !important; font-weight:600; }
  .sidebar a.active{ background:var(--accent); color:#0b1220 !important; font-weight:700; }

  /* Overlay */
  .overlay{
    position:fixed; inset:0; background:rgba(0,0,0,.4);
    opacity:0; pointer-events:none; transition:opacity .3s ease; z-index:10;
  }
  .overlay.active{ opacity:1; pointer-events:all; }

  /* Main + cards */
  .content{ padding:24px; }
  .card{
    max-width:1000px; margin:16px auto; background:#0b1220; border:1px solid var(--border);
    border-radius:16px; padding:20px; box-shadow:0 10px 24px rgba(0,0,0,.25);
  }
  .muted{opacity:.8}

  /* Tiles (ParamÃ¨tres) */
  .stack{ display:grid; gap:12px; }
  .tile{
    display:flex; align-items:center; gap:12px;
    background:var(--tile); border:1px solid var(--border); border-radius:12px;
    padding:14px 16px; cursor:pointer;
  }
  .tile:hover{ border-color:var(--accent); box-shadow:0 0 0 2px rgba(34,197,94,.25) inset; }
  .tile .icon{
    width:36px; height:36px; display:grid; place-items:center;
    background:var(--tileIcon); border:1px solid #1f2a44; border-radius:10px;
  }
  .tile h4{ margin:0; font-size:16px; }
  .tile p{ margin:2px 0 0; font-size:12px; color:#94a3b8; }

  /* Forms & list */
  .row{ display:flex; gap:10px; flex-wrap:wrap; }
  .input, select{ width:100%; max-width:300px; padding:12px; border-radius:10px; border:1px solid #334155; background:#091227; color:#e2e8f0; }
  .btn{ padding:12px 14px; border-radius:10px; border:1px solid #22c55e; color:#22c55e; background:transparent; cursor:pointer }
  .btn:hover{ background:#22c55e; color:#0b1220 }
  .btn.icon{ padding:8px 10px; border-radius:8px; }
  .btn.danger{ border-color:#3b1f1f; color:#fca5a5; }
  .btn.danger:hover{ background:#ef4444; color:#0b1220; border-color:#ef4444; }
  .list{ display:grid; gap:10px; margin-top:14px; }
  .item{
    display:grid; grid-template-columns: 1fr auto; align-items:center; gap:10px;
    background:#0c1526; border:1px solid #243046; border-radius:10px; padding:12px 14px;
  }
  .meta{ display:flex; gap:12px; flex-wrap:wrap; font-size:14px; color:#cbd5e1 }
  .meta b{ color:#e2e8f0 }
  .actions{ display:flex; gap:8px }
  .actions .btn{ min-width:42px; }

  /* Modal */
  .modal-wrap{ position:fixed; inset:0; display:none; place-items:center; z-index:30; }
  .modal-wrap.show{ display:grid; }
  .modal-bg{ position:absolute; inset:0; background:rgba(0,0,0,.55); }
  .modal{ position:relative; width:min(92%,640px); background:#0b1220; border:1px solid var(--border); border-radius:14px; padding:16px 16px 18px; box-shadow:0 20px 40px rgba(0,0,0,.45); }
  .modal h3{ margin:0 0 10px }
  .modal .row{ margin:10px 0 }
  .right{ display:flex; justify-content:flex-end; gap:10px }

  /* Searchable Combo (Ferme) */
  .combo{ position:relative; width:100%; max-width:300px; }
  .combo-input{ width:100%; padding:12px; border-radius:10px; border:1px solid #334155; background:#091227; color:#e2e8f0; }
  .combo-list{
    position:absolute; left:0; right:0; top:100%; background:#0b1220; border:1px solid #243046;
    border-radius:10px; margin-top:6px; max-height:220px; overflow:auto; z-index:40; box-shadow:0 10px 24px rgba(0,0,0,.35);
  }
  .combo-item{ padding:10px 12px; cursor:pointer; }
  .combo-item:hover{ background:#152238; }
</style>
</head>
<body>

  <header>
    <button class="menu-btn" onclick="toggleMenu()">â˜°</button>
    <div class="title">AB AGRIWEB</div>
  </header>

  <aside class="sidebar" id="sidebar">
    <div class="side-header">
      <button class="close-btn" onclick="closeMenu()">Ã—</button>
      <span>Menu</span>
    </div>

    <a href="#" id="nav-home" class="active">ğŸ  Accueil</a>
    <a href="#" id="nav-irrig">ğŸŒ¿ Irrigation</a>
    <a href="#" id="nav-trait">ğŸ’§ Traitement</a>
    <a href="#" id="nav-settings">âš™ï¸ ParamÃ¨tres</a>
    <a href="#" id="logout">ğŸšª Logout</a>
  </aside>

  <div class="overlay" id="overlay"></div>

  <main class="content">
    <!-- PAGE: Accueil -->
    <section id="page-home" class="card">
      <h2>Bienvenue ğŸ‘‹</h2>
      <p class="muted">Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…Ø¨Ø¯Ø¦ÙŠØ©. Ù…Ù† Ù‡Ù†Ø§ Ø³Ù†Ø¶ÙŠÙ Ø£Ù‚Ø³Ø§Ù… Irrigation / Traitement / ParamÃ¨tres Ù„Ø§Ø­Ù‚Ù‹Ø§.</p>
    </section>

    <!-- PAGE: ParamÃ¨tres -->
    <section id="page-settings" class="card hidden">
      <h2>ParamÃ¨tres</h2>
      <p class="muted">Ø§Ø®ØªØ± Ø£Ø­Ø¯ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:</p>
      <div class="stack">
        <div class="tile" onclick="showPage('operators'); setActiveTile()">
          <div class="icon">
            <!-- users -->
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
              <circle cx="9" cy="8" r="3" stroke="#22c55e" stroke-width="2"/>
              <circle cx="17" cy="8" r="3" stroke="#22c55e" stroke-width="2"/>
              <path d="M4 20c1.6-3 4.5-4.2 7-4.2S16.4 17 18 20" stroke="#22c55e" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <div>
            <h4>OPÃ‰RATEUR</h4>
            <p>Gestion des utilisateurs</p>
          </div>
        </div>

        <div class="tile" onclick="showPage('profiles'); setActiveTile()">
          <div class="icon">
            <!-- id-badge -->
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
              <rect x="4" y="5" width="16" height="14" rx="2" stroke="#22c55e" stroke-width="2"/>
              <circle cx="12" cy="11" r="2.5" stroke="#22c55e" stroke-width="2"/>
              <path d="M8 17c1.2-1.5 3-2.3 4-2.3s2.8.8 4 2.3" stroke="#22c55e" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <div>
            <h4>PROFILE</h4>
            <p>Gestion des profils (rÃ´les)</p>
          </div>
        </div>

        <div class="tile" onclick="alert('DROITS ACCÃˆS (Ã  complÃ©ter)')">
          <div class="icon">
            <!-- shield -->
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="M12 3l7 3v6c0 5-3.5 7.8-7 9-3.5-1.2-7-4-7-9V6l7-3z" stroke="#22c55e" stroke-width="2"/>
              <path d="M9 12l2 2 4-4" stroke="#22c55e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div>
            <h4>DROITS ACCÃˆS</h4>
            <p>Permissions & rÃ´les</p>
          </div>
        </div>

        <div class="tile" onclick="showPage('farms'); setActiveTile()">
          <div class="icon">
            <!-- farm/field -->
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="M3 20h18M3 14l6-4 6 4 6-4" stroke="#22c55e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M6 20v-6m12 6v-6" stroke="#22c55e" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <div>
            <h4>FERME</h4>
            <p>Gestion des fermes</p>
          </div>
        </div>

        <div class="tile" onclick="alert('MOT DE PASSE (Ã  complÃ©ter)')">
          <div class="icon">
            <!-- key -->
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
              <circle cx="8" cy="12" r="3" stroke="#22c55e" stroke-width="2"/>
              <path d="M11 12h9M17 12v3M20 12v3" stroke="#22c55e" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <div>
            <h4>MOT DE PASSE</h4>
            <p>Changer le mot de passe</p>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: Profiles -->
    <section id="page-profiles" class="card hidden">
      <h2>Profiles</h2>
      <p class="muted">Ø£Ø¶Ù/Ø§Ø­Ø°Ù Ø£Ø¯ÙˆØ§Ø± (Profils). ÙŠØªÙ… Ø­ÙØ¸Ù‡Ø§ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­.</p>

      <button id="showAddFormBtn" class="btn" style="margin-top:12px" onclick="toggleAddForm(true)">â• Ajouter un profil</button>

      <div id="addForm" class="row hidden" style="margin-top:12px">
        <input id="profileName" class="input" placeholder="Ex: Admin, Magasinier, Pointeur, Directeur">
        <button class="btn" onclick="addProfile()">Confirmer</button>
        <button class="btn danger" onclick="toggleAddForm(false)">Annuler</button>
      </div>

      <div id="profilesList" class="list" style="margin-top:14px"></div>

      <p class="muted" style="margin-top:10px">Sauvegarde locale : <code>localStorage</code> (clÃ© : <b>ab_profiles</b>).</p>
      <div class="row" style="margin-top:6px">
        <button class="btn danger" onclick="resetDefaults()">RÃ©initialiser aux rÃ´les par dÃ©faut</button>
      </div>
    </section>

    <!-- PAGE: OpÃ©rateurs -->
    <section id="page-operators" class="card hidden">
      <h2>OpÃ©rateurs</h2>
      <p class="muted">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ø§Ù„Ø§Ø³Ù…ØŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŒ Ø§Ù„Ø¨Ø±ÙˆÙÙŠÙ„ØŒ Ø§Ù„Ø¶ÙŠØ¹Ø©). Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§.</p>

      <button id="opShowAddBtn" class="btn" style="margin-top:12px" onclick="opToggleForm(true)">â• Ajouter un opÃ©rateur</button>

      <div id="opAddForm" class="row hidden" style="margin-top:12px">
        <input id="op_username" class="input" placeholder="Nom dâ€™utilisateur">
        <input id="op_password" type="password" class="input" placeholder="Mot de passe">
        <select id="op_profile" class="input"></select>

        <!-- Ferme combobox (searchable) -->
        <div class="combo" id="combo-op-ferme">
          <input id="op_ferme_input" class="combo-input" placeholder="Chercher/choisir une ferme...">
          <div id="op_ferme_list" class="combo-list hidden"></div>
          <input type="hidden" id="op_ferme" />
        </div>

        <button class="btn" onclick="opAdd()">Confirmer</button>
        <button class="btn danger" onclick="opToggleForm(false)">Annuler</button>
      </div>

      <div id="operatorsList" class="list" style="margin-top:14px"></div>
    </section>

    <!-- PAGE: Fermes -->
    <section id="page-farms" class="card hidden">
      <h2>Fermes</h2>
      <p class="muted">Ø£Ø¶Ù ÙˆÙ†Ø³Ù‘Ù‚ Ø§Ù„Ø¶ÙŠØ¹Ø§Øª. Ø³ÙŠØªÙ… Ø§Ø³ØªØ¹Ù…Ø§Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù„Ø§Ø¦Ø­Ø© ÙÙŠ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¶ÙŠØ¹Ø© Ø¯Ø§Ø®Ù„ ØµÙØ­Ø© OpÃ©rateurs.</p>

      <button id="farmShowAddBtn" class="btn" style="margin-top:12px" onclick="farmToggleForm(true)">â• Ajouter une ferme</button>

      <div id="farmAddForm" class="row hidden" style="margin-top:12px">
        <input id="farm_name" class="input" placeholder="Nom de la ferme (ex: Karam 16)">
        <input id="farm_area" class="input" placeholder="Surface (ex: 12 ha)">
        <input id="farm_company" class="input" placeholder="SociÃ©tÃ©">
        <input id="farm_location" class="input" placeholder="Emplacement">
        <input id="farm_manager" class="input" placeholder="Responsable">
        <input id="farm_phone" class="input" placeholder="TÃ©lÃ©phone du responsable">
        <button class="btn" onclick="farmAdd()">Confirmer</button>
        <button class="btn danger" onclick="farmToggleForm(false)">Annuler</button>
      </div>

      <div id="farmsList" class="list" style="margin-top:14px"></div>
    </section>
  </main>

  <!-- MODAL: edit operator -->
  <div id="opModal" class="modal-wrap">
    <div class="modal-bg" onclick="opCloseModal()"></div>
    <div class="modal">
      <h3>Modifier lâ€™opÃ©rateur</h3>
      <div class="row">
        <input id="edit_username" class="input" placeholder="Nom dâ€™utilisateur">
        <input id="edit_password" type="password" class="input" placeholder="Mot de passe">
      </div>
      <div class="row">
        <select id="edit_profile" class="input"></select>

        <!-- Ferme combobox in modal -->
        <div class="combo" id="combo-edit-ferme">
          <input id="edit_ferme_input" class="combo-input" placeholder="Chercher/choisir une ferme...">
          <div id="edit_ferme_list" class="combo-list hidden"></div>
          <input type="hidden" id="edit_ferme" />
        </div>
      </div>
      <div class="right" style="margin-top:8px">
        <button class="btn danger" onclick="opCloseModal()">Annuler</button>
        <button class="btn" onclick="opSaveEdit()">Enregistrer</button>
      </div>
    </div>
  </div>

  <!-- MODAL: edit farm -->
  <div id="farmModal" class="modal-wrap">
    <div class="modal-bg" onclick="farmCloseModal()"></div>
    <div class="modal">
      <h3>Modifier la ferme</h3>
      <div class="row">
        <input id="edit_farm_name" class="input" placeholder="Nom de la ferme">
        <input id="edit_farm_area" class="input" placeholder="Surface">
      </div>
      <div class="row">
        <input id="edit_farm_company" class="input" placeholder="SociÃ©tÃ©">
        <input id="edit_farm_location" class="input" placeholder="Emplacement">
      </div>
      <div class="row">
        <input id="edit_farm_manager" class="input" placeholder="Responsable">
        <input id="edit_farm_phone" class="input" placeholder="TÃ©lÃ©phone">
      </div>
      <div class="right" style="margin-top:8px">
        <button class="btn danger" onclick="farmCloseModal()">Annuler</button>
        <button class="btn" onclick="farmSaveEdit()">Enregistrer</button>
      </div>
    </div>
  </div>

<script>
  /* ---------- Sidebar + overlay ---------- */
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('overlay');

  function openMenu(){ sidebar.classList.add('active'); overlay.classList.add('active'); }
  function closeMenu(){ sidebar.classList.remove('active'); overlay.classList.remove('active'); }
  function toggleMenu(){ sidebar.classList.contains('active') ? closeMenu() : openMenu(); }

  document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeMenu(); });
  overlay.addEventListener('click', closeMenu);

  /* ---------- Routing ---------- */
  const navHome=document.getElementById('nav-home');
  const navSet=document.getElementById('nav-settings');
  const pageHome=document.getElementById('page-home');
  const pageSet=document.getElementById('page-settings');
  const pageProf=document.getElementById('page-profiles');
  const pageOps=document.getElementById('page-operators');
  const pageFarms=document.getElementById('page-farms');

  function setActiveLink(link){
    document.querySelectorAll('.sidebar a').forEach(a=>a.classList.remove('active'));
    link.classList.add('active');
  }
  function showPage(name){
    [pageHome,pageSet,pageProf,pageOps,pageFarms].forEach(p=>p.classList.add('hidden'));
    if(name==='home') pageHome.classList.remove('hidden');
    if(name==='settings') pageSet.classList.remove('hidden');
    if(name==='profiles') pageProf.classList.remove('hidden');
    if(name==='operators') pageOps.classList.remove('hidden');
    if(name==='farms') pageFarms.classList.remove('hidden');
    closeMenu();
  }
  navHome.addEventListener('click',e=>{e.preventDefault();setActiveLink(navHome);showPage('home');});
  navSet.addEventListener('click',e=>{e.preventDefault();setActiveLink(navSet);showPage('settings');});
  function setActiveTile(){setActiveLink(navSet);} // Ù†Ø¨Ù‚Ù‰ Ø¯Ø§Ø®Ù„ ParamÃ¨tres

  document.getElementById('logout').addEventListener('click',e=>{
    e.preventDefault();window.location='index.html';
  });

  /* ---------- Profiles CRUD (localStorage) ---------- */
  const LS_PROFILES='ab_profiles';
  const DEFAULT_PROFILES=["Admin","Magasinier","Pointeur","Directeur"];

  function loadProfiles(){ try{return JSON.parse(localStorage.getItem(LS_PROFILES))||[];}catch{return [];} }
  function saveProfiles(arr){ localStorage.setItem(LS_PROFILES, JSON.stringify(arr)); }
  function renderProfiles(){
    const list=document.getElementById('profilesList'); if(!list) return;
    const data=loadProfiles();
    if(data.length===0){list.innerHTML='<div class="item"><span class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø±ÙˆÙØ§ÙŠÙ„Ø§Øª Ø¨Ø¹Ø¯.</span></div>';return;}
    list.innerHTML=data.map((n,i)=>`
      <div class="item">
        <div class="meta"><b>${escapeHtml(n)}</b></div>
        <div class="actions">
          <button class="btn danger icon" onclick="removeProfile(${i})">ğŸ—‘ï¸</button>
        </div>
      </div>`).join('');
  }
  function addProfile(){
    const inp=document.getElementById('profileName'); const name=inp.value.trim();
    if(!name){alert('Entrer un nom de profil.');return;}
    const data=loadProfiles();
    if(data.some(x=>x.toLowerCase()===name.toLowerCase())){alert('Ce profil existe dÃ©jÃ .');return;}
    data.push(name); saveProfiles(data);
    inp.value=''; toggleAddForm(false); renderProfiles(); opRefreshProfileSelects();
  }
  function removeProfile(i){
    const data=loadProfiles(); if(!confirm('Supprimer le profil : '+data[i]+' ?'))return;
    data.splice(i,1); saveProfiles(data); renderProfiles(); opRefreshProfileSelects();
  }
  function resetDefaults(){
    if(!confirm('RÃ©initialiser aux rÃ´les par dÃ©faut ?'))return;
    saveProfiles(DEFAULT_PROFILES.slice()); renderProfiles(); opRefreshProfileSelects();
  }
  function toggleAddForm(show){
    const form=document.getElementById('addForm'); const btn=document.getElementById('showAddFormBtn');
    if(!form||!btn)return;
    if(show){form.classList.remove('hidden');btn.classList.add('hidden');document.getElementById('profileName').focus();}
    else{form.classList.add('hidden');btn.classList.remove('hidden');}
  }

  /* ---------- Farms CRUD (localStorage) ---------- */
  const LS_FARMS='ab_farms';
  function loadFarms(){ try{return JSON.parse(localStorage.getItem(LS_FARMS))||[];}catch{return [];} }
  function saveFarms(arr){ localStorage.setItem(LS_FARMS, JSON.stringify(arr)); }

  function farmToggleForm(show){
    const f=document.getElementById('farmAddForm'); const b=document.getElementById('farmShowAddBtn');
    if(show){f.classList.remove('hidden'); b.classList.add('hidden'); document.getElementById('farm_name').focus();}
    else{f.classList.add('hidden'); b.classList.remove('hidden');}
  }
  function farmAdd(){
    const name=document.getElementById('farm_name').value.trim();
    const area=document.getElementById('farm_area').value.trim();
    const company=document.getElementById('farm_company').value.trim();
    const location=document.getElementById('farm_location').value.trim();
    const manager=document.getElementById('farm_manager').value.trim();
    const phone=document.getElementById('farm_phone').value.trim();
    if(!name){ alert('Nom de la ferme requis.'); return; }
    const data=loadFarms();
    if(data.some(x=>x.name.toLowerCase()===name.toLowerCase())){ alert('Cette ferme existe dÃ©jÃ .'); return; }
    data.push({name,area,company,location,manager,phone}); saveFarms(data);
    farmToggleForm(false); renderFarms(); opRefreshFarmCombos();
  }
  function renderFarms(){
    const wrap=document.getElementById('farmsList'); if(!wrap) return;
    const data=loadFarms();
    if(data.length===0){ wrap.innerHTML='<div class="item"><span class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¶ÙŠØ¹Ø§Øª Ø¨Ø¹Ø¯.</span></div>'; return; }
    wrap.innerHTML = data.map((f,i)=>`
      <div class="item">
        <div class="meta">
          <span><b>Ferme:</b> ${escapeHtml(f.name)}</span>
          <span><b>Surface:</b> ${escapeHtml(f.area||'')}</span>
          <span><b>SociÃ©tÃ©:</b> ${escapeHtml(f.company||'')}</span>
          <span><b>Lieu:</b> ${escapeHtml(f.location||'')}</span>
          <span><b>Resp.:</b> ${escapeHtml(f.manager||'')}</span>
          <span><b>TÃ©l:</b> ${escapeHtml(f.phone||'')}</span>
        </div>
        <div class="actions">
          <button class="btn icon" onclick="farmEdit(${i})">âœï¸</button>
          <button class="btn danger icon" onclick="farmDelete(${i})">ğŸ—‘ï¸</button>
        </div>
      </div>
    `).join('');
  }
  // edit farm (modal)
  let farmEditIndex=null;
  function farmEdit(i){
    const f=loadFarms()[i]; farmEditIndex=i;
    document.getElementById('edit_farm_name').value=f.name||'';
    document.getElementById('edit_farm_area').value=f.area||'';
    document.getElementById('edit_farm_company').value=f.company||'';
    document.getElementById('edit_farm_location').value=f.location||'';
    document.getElementById('edit_farm_manager').value=f.manager||'';
    document.getElementById('edit_farm_phone').value=f.phone||'';
    farmOpenModal();
  }
  function farmOpenModal(){ document.getElementById('farmModal').classList.add('show'); }
  function farmCloseModal(){ document.getElementById('farmModal').classList.remove('show'); farmEditIndex=null; }
  function farmSaveEdit(){
    if(farmEditIndex===null) return;
    const data=loadFarms();
    const v={
      name:document.getElementById('edit_farm_name').value.trim(),
      area:document.getElementById('edit_farm_area').value.trim(),
      company:document.getElementById('edit_farm_company').value.trim(),
      location:document.getElementById('edit_farm_location').value.trim(),
      manager:document.getElementById('edit_farm_manager').value.trim(),
      phone:document.getElementById('edit_farm_phone').value.trim(),
    };
    if(!v.name){ alert('Nom de la ferme requis.'); return; }
    // check duplicate name (excluding current)
    if(v.name.toLowerCase()!==data[farmEditIndex].name.toLowerCase() &&
       data.some(x=>x.name.toLowerCase()===v.name.toLowerCase())){
      alert('Nom de ferme dÃ©jÃ  utilisÃ©.'); return;
    }
    data[farmEditIndex]=v; saveFarms(data); farmCloseModal(); renderFarms(); opRefreshFarmCombos();
  }
  function farmDelete(i){
    const data=loadFarms(); if(!confirm('Supprimer la ferme: '+data[i].name+' ?')) return;
    const removedName=data[i].name;
    data.splice(i,1); saveFarms(data); renderFarms(); opRefreshFarmCombos();
    // If operators were using this farm, keep their value as text (no hard unlink here)
    // You can later add validation to prevent orphaned farm refs.
  }

  /* ---------- Operators CRUD (localStorage) ---------- */
  const LS_OPERATORS='ab_operators';
  function loadOps(){ try{return JSON.parse(localStorage.getItem(LS_OPERATORS))||[];}catch{return [];} }
  function saveOps(arr){ localStorage.setItem(LS_OPERATORS, JSON.stringify(arr)); }

  function opToggleForm(show){
    const form=document.getElementById('opAddForm');
    const btn=document.getElementById('opShowAddBtn');
    if(show){
      form.classList.remove('hidden'); btn.classList.add('hidden');
      opRefreshProfileSelects(); opRefreshFarmCombos();
      document.getElementById('op_username').focus();
    } else {
      form.classList.add('hidden'); btn.classList.remove('hidden');
    }
  }

  function opBuildProfileOptions(selectId){
    const sel=document.getElementById(selectId); if(!sel) return;
    const prof=loadProfiles();
    sel.innerHTML = prof.length ? prof.map(p=>`<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join('') : `<option value="">(Aucun profil)</option>`;
  }
  function opRefreshProfileSelects(){ opBuildProfileOptions('op_profile'); opBuildProfileOptions('edit_profile'); }

  // ----- Searchable combo helpers -----
  function comboFill(idBase, items){
    const input=document.getElementById(idBase+'_input');
    const list=document.getElementById(idBase+'_list');
    const hidden=document.getElementById(idBase);
    function render(filter=''){
      const q=filter.toLowerCase();
      const matched=items.filter(x=>x.toLowerCase().includes(q));
      list.innerHTML = matched.map(v=>`<div class="combo-item" data-v="${escapeHtml(v)}">${escapeHtml(v)}</div>`).join('') || `<div class="combo-item muted">(aucun rÃ©sultat)</div>`;
    }
    render('');
    input.oninput = ()=> render(input.value);
    input.onfocus = ()=> { list.classList.remove('hidden'); render(input.value); };
    document.addEventListener('click', (e)=>{
      if(!list.contains(e.target) && e.target!==input) list.classList.add('hidden');
    });
    list.onclick = (e)=>{
      const el=e.target.closest('.combo-item'); if(!el) return;
      const v=el.getAttribute('data-v'); if(!v) return;
      input.value=v; hidden.value=v; list.classList.add('hidden');
    };
  }

  function opRefreshFarmCombos(){
    const farms=loadFarms().map(f=>f.name);
    // create for add form
    comboFill('op_ferme', farms);
    // create for edit modal
    comboFill('edit_ferme', farms);
  }

  function renderOps(){
    const wrap=document.getElementById('operatorsList'); if(!wrap) return;
    const data=loadOps();
    if(data.length===0){
      wrap.innerHTML='<div class="item"><span class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¯.</span></div>';
      return;
    }
    wrap.innerHTML=data.map((u,idx)=>`
      <div class="item">
        <div class="meta">
          <span><b>Utilisateur:</b> ${escapeHtml(u.username)}</span>
          <span><b>Profil:</b> ${escapeHtml(u.profile||'')}</span>
          <span><b>Ferme:</b> ${escapeHtml(u.ferme||'')}</span>
        </div>
        <div class="actions">
          <button class="btn icon" onclick="opEdit(${idx})">âœï¸</button>
          <button class="btn danger icon" onclick="opDelete(${idx})">ğŸ—‘ï¸</button>
        </div>
      </div>
    `).join('');
  }

  function opAdd(){
    const username=document.getElementById('op_username').value.trim();
    const password=document.getElementById('op_password').value.trim();
    const profile =document.getElementById('op_profile').value.trim();
    const ferme   =document.getElementById('op_ferme').value.trim(); // from hidden
    if(!username || !password || !profile || !ferme){
      alert('Remplir tous les champs.'); return;
    }
    const data=loadOps();
    if(data.some(x=>x.username.toLowerCase()===username.toLowerCase())){ alert('Cet utilisateur existe dÃ©jÃ .'); return; }
    data.push({username,password,profile,ferme}); saveOps(data);
    // clear
    document.getElementById('op_username').value='';
    document.getElementById('op_password').value='';
    document.getElementById('op_ferme_input').value=''; document.getElementById('op_ferme').value='';
    opToggleForm(false); renderOps();
  }

  // Edit modal
  let editIndex=null;
  function opOpenModal(){ document.getElementById('opModal').classList.add('show'); }
  function opCloseModal(){ document.getElementById('opModal').classList.remove('show'); editIndex=null; }

  function opEdit(idx){
    const data=loadOps(); const u=data[idx]; editIndex=idx;
    document.getElementById('edit_username').value=u.username;
    document.getElementById('edit_password').value=u.password;
    opRefreshProfileSelects(); document.getElementById('edit_profile').value=u.profile||'';
    opRefreshFarmCombos();
    document.getElementById('edit_ferme_input').value=u.ferme||''; document.getElementById('edit_ferme').value=u.ferme||'';
    opOpenModal();
  }
  function opSaveEdit(){
    if(editIndex===null) return;
    const data=loadOps();
    const u=data[editIndex];
    const newUser=document.getElementById('edit_username').value.trim();
    const newPwd =document.getElementById('edit_password').value.trim();
    const newProf=document.getElementById('edit_profile').value.trim();
    const newFer =document.getElementById('edit_ferme').value.trim();
    if(!newUser || !newPwd || !newProf || !newFer){ alert('Remplir tous les champs.'); return; }
    if(newUser.toLowerCase()!==u.username.toLowerCase() && data.some(x=>x.username.toLowerCase()===newUser.toLowerCase())){
      alert('Nom dâ€™utilisateur dÃ©jÃ  utilisÃ©.'); return;
    }
    data[editIndex]={username:newUser, password:newPwd, profile:newProf, ferme:newFer};
    saveOps(data); opCloseModal(); renderOps();
  }
  function opDelete(idx){
    const data=loadOps(); if(!confirm('Supprimer lâ€™utilisateur: '+data[idx].username+' ?')) return;
    data.splice(idx,1); saveOps(data); renderOps();
  }

  /* ---------- Helpers ---------- */
  function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

  /* ---------- INIT ---------- */
  (function init(){
    // ensure default profiles on first run
    if(!localStorage.getItem(LS_PROFILES)) saveProfiles(DEFAULT_PROFILES.slice());
    renderProfiles();
    renderFarms();
    opRefreshProfileSelects();
    opRefreshFarmCombos();
    renderOps();
  })();
</script>

</body>
</html>
