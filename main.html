<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>AB AGRIWEB - Dashboard</title>
<style>
  :root{
    --bg:#0f172a; --panel:#0b1220; --text:#e2e8f0; --accent:#22c55e; --border:#243046;
    --tile:#0c1526; --tileIcon:#0f1a2e; --warn:#fde68a1a;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:linear-gradient(180deg,var(--bg),#1e293b); color:var(--text);
    min-height:100vh; overflow-x:hidden;
  }
  .hidden{display:none !important;}

  /* Header */
  header{
    position:sticky; top:0; z-index:20;
    display:flex; align-items:center; justify-content:space-between;
    background:var(--panel); padding:12px 18px; border-bottom:1px solid var(--border);
    box-shadow:0 2px 12px rgba(0,0,0,.25);
  }
  .menu-btn{ background:none; border:none; color:var(--text); font-size:24px; cursor:pointer; }
  .title{ font-weight:800; color:var(--accent); letter-spacing:.5px }

  /* Sidebar */
  .sidebar{
    position:fixed; top:0; left:-260px; width:260px; height:100%;
    background:#0b1220; border-right:1px solid var(--border);
    transition:left .35s ease; display:flex; flex-direction:column; padding-top:56px;
    box-shadow:4px 0 20px rgba(0,0,0,.4); z-index:15;
  }
  .sidebar.active{ left:0; }
  .side-header{
    position:absolute; top:0; left:0; right:0; height:56px;
    display:flex; align-items:center; gap:10px; padding:0 14px;
    border-bottom:1px solid #1e293b; background:#0b1220;
  }
  .close-btn{
    width:36px; height:36px; border:none; border-radius:8px; cursor:pointer;
    background:#111827; color:#e2e8f0; font-size:22px; line-height:1;
  }
  .close-btn:hover{ background:#0f172a; }
  .side-header span{ font-weight:700; color:#cbd5e1 }

  .sidebar a{
    display:flex; align-items:center; gap:10px; padding:14px 24px;
    color:var(--text) !important; text-decoration:none; border-bottom:1px solid #1e293b;
  }
  .sidebar a:hover{ background:var(--accent); color:#0b1220 !important; font-weight:600; }
  .sidebar a.active{ background:var(--accent); color:#0b1220 !important; font-weight:700; }

  /* Overlay */
  .overlay{
    position:fixed; inset:0; background:rgba(0,0,0,.4);
    opacity:0; pointer-events:none; transition:opacity .3s ease; z-index:10;
  }
  .overlay.active{ opacity:1; pointer-events:all; }

  /* Cards */
  .content{ padding:24px; }
  .card{
    max-width:1000px; margin:16px auto; background:#0b1220; border:1px solid var(--border);
    border-radius:16px; padding:20px; box-shadow:0 10px 24px rgba(0,0,0,.25);
    position:relative;
  }
  .muted{opacity:.8}
  .hint{background:var(--warn); border:1px dashed #fbbf24; color:#fcd34d; padding:8px 10px; border-radius:8px; font-size:13px;}

  /* Tiles */
  .stack{ display:grid; gap:12px; }
  .tile{
    display:flex; align-items:center; gap:12px;
    background:var(--tile); border:1px solid var(--border); border-radius:12px;
    padding:14px 16px; cursor:pointer;
  }
  .tile:hover{ border-color:var(--accent); box-shadow:0 0 0 2px rgba(34,197,94,.25) inset; }
  .tile .icon{
    width:36px; height:36px; display:grid; place-items:center;
    background:var(--tileIcon); border:1px solid #1f2a44; border-radius:10px;
  }
  .tile h4{ margin:0; font-size:16px; }
  .tile p{ margin:2px 0 0; font-size:12px; color:#94a3b8; }

  /* Top-right actions */
  .actions-top{
    position:absolute; top:16px; right:16px; display:flex; gap:8px;
  }
  .btn{ padding:10px 12px; border-radius:10px; border:1px solid #22c55e; color:#22c55e; background:transparent; cursor:pointer }
  .btn:hover{ background:#22c55e; color:#0b1220 }
  .btn.icon{ width:40px; height:40px; display:grid; place-items:center; padding:0; }
  .btn.danger{ border-color:#3b1f1f; color:#fca5a5; }
  .btn.danger:hover{ background:#ef4444; color:#0b1220; border-color:#ef4444; }

  /* Forms & lists */
  .row{ display:flex; gap:10px; flex-wrap:wrap; }
  .input, select, textarea{ width:100%; max-width:360px; padding:12px; border-radius:10px; border:1px solid #334155; background:#091227; color:#e2e8f0; }
  .list{ display:grid; gap:10px; margin-top:14px; }
  .item{
    display:grid; grid-template-columns: 1fr auto; align-items:center; gap:10px;
    background:#0c1526; border:1px solid #243046; border-radius:10px; padding:12px 14px;
  }
  .meta{ display:flex; gap:12px; flex-wrap:wrap; font-size:14px; color:#cbd5e1 }
  .meta b{ color:#e2e8f0 }
  .actions{ display:flex; gap:8px }
  .actions .btn{ min-width:42px; }

  /* Simple grid for app settings */
  .grid{ display:grid; gap:12px; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); }
  .label{ font-size:13px; color:#9fb2cc; margin-bottom:6px; display:block; }
  .sectionTitle{ margin:16px 0 8px; font-weight:700; color:#cde4d5 }
</style>
</head>
<body>

  <header>
    <button class="menu-btn" onclick="toggleMenu()">â˜°</button>
    <div class="title" id="appTitleTop">AB AGRIWEB</div>
  </header>

  <aside class="sidebar" id="sidebar">
    <div class="side-header">
      <button class="close-btn" onclick="closeMenu()">Ã—</button>
      <span>Menu</span>
    </div>

    <a href="#" id="nav-home" class="active"><span id="lbl-nav-home">ğŸ  Accueil</span></a>
    <a href="#" id="nav-irrig"><span id="lbl-nav-irrig">ğŸŒ¿ Irrigation</span></a>
    <a href="#" id="nav-trait"><span id="lbl-nav-trait">ğŸ’§ Traitement</span></a>
    <a href="#" id="nav-settings"><span id="lbl-nav-settings">âš™ï¸ ParamÃ¨tres</span></a>
    <a href="#" id="logout"><span id="lbl-nav-logout">ğŸšª Logout</span></a>
  </aside>

  <div class="overlay" id="overlay"></div>

  <main class="content">
    <!-- PAGE: Accueil -->
    <section id="page-home" class="card">
      <h2>Bienvenue ğŸ‘‹</h2>
      <p class="muted">Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…Ø¨Ø¯Ø¦ÙŠØ©. Ù…Ù† Ù‡Ù†Ø§ Ø³Ù†Ø¶ÙŠÙ Ø£Ù‚Ø³Ø§Ù… Irrigation / Traitement / ParamÃ¨tres Ù„Ø§Ø­Ù‚Ù‹Ø§.</p>
    </section>

    <!-- PAGE: ParamÃ¨tres -->
    <section id="page-settings" class="card hidden">
      <h2 id="title-settings">ParamÃ¨tres</h2>
      <p class="muted">Ø§Ø®ØªØ± Ø£Ø­Ø¯ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:</p>
      <div class="stack">
        <div class="tile" onclick="showPage('operators'); setActiveTile()">
          <div class="icon">ğŸ‘¥</div>
          <div><h4 id="lbl-tile-operators">OPÃ‰RATEUR</h4><p>Gestion des utilisateurs</p></div>
        </div>

        <div class="tile" onclick="showPage('profiles'); setActiveTile()">
          <div class="icon">ğŸ§©</div>
          <div><h4 id="lbl-tile-profiles">PROFILE</h4><p>Gestion des profils (rÃ´les)</p></div>
        </div>

        <div class="tile" onclick="showPage('refs'); setActiveTile()">
          <div class="icon">ğŸ—‚ï¸</div>
          <div><h4 id="lbl-tile-refs">RÃ‰FÃ‰RENTIELS</h4><p>Listes maÃ®tres</p></div>
        </div>

        <div class="tile" onclick="alert('DROITS ACCÃˆS (Ã  complÃ©ter)')">
          <div class="icon">ğŸ›¡ï¸</div>
          <div><h4 id="lbl-tile-rights">DROITS ACCÃˆS</h4><p>Permissions & rÃ´les</p></div>
        </div>

        <div class="tile" onclick="alert('MOT DE PASSE (Ã  complÃ©ter)')">
          <div class="icon">ğŸ”‘</div>
          <div><h4 id="lbl-tile-pass">MOT DE PASSE</h4><p>Changer le mot de passe</p></div>
        </div>

        <!-- NEW: RÃ©glages app -->
        <div class="tile" onclick="showPage('appcfg'); setActiveTile()">
          <div class="icon">âš™ï¸</div>
          <div><h4 id="lbl-tile-appcfg">RÃ‰GLAGES APP</h4><p>Nom Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ùˆ ØªØ³Ù…ÙŠØ§Øª Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…</p></div>
        </div>
      </div>
    </section>

    <!-- PAGE: Profiles -->
    <section id="page-profiles" class="card hidden">
      <div class="actions-top">
        <button class="btn icon" title="Ajouter" onclick="toggleAddForm(true)">â•</button>
        <button class="btn icon" title="Modifier (Ø§Ø³ØªØ¹Ù…Ù„ âœï¸ Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø¹Ù†Ø§ØµØ±)" onclick="showProfilesHint()">âœï¸</button>
      </div>
      <h2>Profiles</h2>
      <div id="profilesHint" class="hint hidden">Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù†ØµØ±ØŒ Ø§Ø³ØªØ¹Ù…Ù„ Ø²Ø± âœï¸ Ø¨Ø¬Ø§Ù†Ø¨Ù‡.</div>

      <div id="addForm" class="row hidden" style="margin-top:12px">
        <input id="profileName" class="input" placeholder="Ex: Admin, Magasinier, Pointeur, Directeur">
        <button class="btn" onclick="addProfile()">Confirmer</button>
        <button class="btn danger" onclick="toggleAddForm(false)">Annuler</button>
      </div>

      <div id="profilesList" class="list" style="margin-top:14px"></div>
    </section>

    <!-- PAGE: OpÃ©rateurs -->
    <section id="page-operators" class="card hidden">
      <div class="actions-top">
        <button class="btn icon" title="Ajouter" onclick="opToggleForm(true)">â•</button>
        <button class="btn icon" title="Modifier" onclick="showOpsHint()">âœï¸</button>
      </div>
      <h2>OpÃ©rateurs</h2>
      <div id="opsHint" class="hint hidden">Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ø§Ø³ØªØ¹Ù…Ù„ Ø²Ø± âœï¸ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„Ø§Ø¦Ø­Ø©.</div>
      <p class="muted">Ø§Ù„Ø§Ø³Ù…ØŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŒ Ø§Ù„Ø¨Ø±ÙˆÙÙŠÙ„ØŒ Ø§Ù„Ø¶ÙŠØ¹Ø©.</p>

      <div id="opAddForm" class="row hidden" style="margin-top:12px">
        <input id="op_username" class="input" placeholder="Nom dâ€™utilisateur">
        <input id="op_password" type="password" class="input" placeholder="Mot de passe">
        <select id="op_profile" class="input"></select>

        <div class="combo" id="combo-op-ferme" style="max-width:360px; width:100%">
          <input id="op_ferme_input" class="input" placeholder="Chercher/choisir une ferme...">
          <div id="op_ferme_list" class="combo-list hidden"></div>
          <input type="hidden" id="op_ferme" />
        </div>

        <button class="btn" onclick="opAdd()">Confirmer</button>
        <button class="btn danger" onclick="opToggleForm(false)">Annuler</button>
      </div>

      <div id="operatorsList" class="list" style="margin-top:14px"></div>
    </section>

    <!-- PAGE: Fermes -->
    <section id="page-farms" class="card hidden">
      <div class="actions-top">
        <button class="btn icon" title="Ajouter" onclick="farmToggleForm(true)">â•</button>
        <button class="btn icon" title="Modifier" onclick="showFarmsHint()">âœï¸</button>
      </div>
      <h2>Fermes</h2>
      <div id="farmsHint" class="hint hidden">Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¶ÙŠØ¹Ø©ØŒ Ø§Ø³ØªØ¹Ù…Ù„ Ø²Ø± âœï¸ ÙÙŠ Ø§Ù„Ù„Ø§Ø¦Ø­Ø©.</div>

      <div id="farmAddForm" class="row hidden" style="margin-top:12px">
        <input id="farm_name" class="input" placeholder="Nom de la ferme (ex: Karam 16)">
        <input id="farm_area" class="input" placeholder="Surface (ex: 12 ha)">
        <input id="farm_company" class="input" placeholder="SociÃ©tÃ©">
        <input id="farm_location" class="input" placeholder="Emplacement">
        <input id="farm_manager" class="input" placeholder="Responsable">
        <input id="farm_phone" class="input" placeholder="TÃ©lÃ©phone du responsable">
        <button class="btn" onclick="farmAdd()">Confirmer</button>
        <button class="btn danger" onclick="farmToggleForm(false)">Annuler</button>
      </div>

      <div id="farmsList" class="list" style="margin-top:14px"></div>
    </section>

    <!-- PAGE: RÃ©fÃ©rentiels -->
    <section id="page-refs" class="card hidden">
      <h2>RÃ©fÃ©rentiels</h2>
      <p class="muted">Ù„ÙˆØ§Ø¦Ø­ Ù…Ø±Ø¬Ø¹ÙŠØ©.</p>

      <div id="refsHome" class="stack">
        <div class="tile" onclick="showPage('farms'); setActiveTile()">
          <div class="icon">ğŸï¸</div>
          <div><h4 id="lbl-ref-ferme">Ferme</h4><p>Gestion des fermes</p></div>
        </div>

        <div class="tile" onclick="refsOpen('companies')"><div class="icon">ğŸ¢</div><div><h4 id="lbl-ref-companies">SociÃ©tÃ©</h4><p>Gestion des sociÃ©tÃ©s</p></div></div>
        <div class="tile" onclick="refsOpen('responsables')"><div class="icon">ğŸ‘¤</div><div><h4 id="lbl-ref-responsables">Responsable</h4><p>Chefs de ferme</p></div></div>

        <div class="tile" onclick="refsOpen('stations')"><div class="icon">ğŸš</div><div><h4 id="lbl-ref-stations">Station</h4><p>Stations dâ€™irrigation</p></div></div>
        <div class="tile" onclick="refsOpen('secteurs')"><div class="icon">ğŸ§­</div><div><h4 id="lbl-ref-secteurs">Secteur</h4><p>Zones/secteurs</p></div></div>

        <div class="tile" onclick="refsOpen('parcelles')"><div class="icon">ğŸ§±</div><div><h4 id="lbl-ref-parcelles">Parcelle</h4><p>Parcelles/champs</p></div></div>
        <div class="tile" onclick="refsOpen('transports')"><div class="icon">ğŸšš</div><div><h4 id="lbl-ref-transports">Transport</h4><p>Moyens de transport</p></div></div>

        <div class="tile" onclick="refsOpen('varietes')"><div class="icon">ğŸŒ±</div><div><h4 id="lbl-ref-varietes">VariÃ©tÃ©</h4><p>VariÃ©tÃ©s gÃ©nÃ©rales</p></div></div>
        <div class="tile" onclick="refsOpen('varietes_champ')"><div class="icon">ğŸŒ¿</div><div><h4 id="lbl-ref-varietes_champ">VariÃ©tÃ© champ</h4><p>VariÃ©tÃ©s par champ</p></div></div>

        <div class="tile" onclick="refsOpen('gestions')"><div class="icon">ğŸ“¦</div><div><h4 id="lbl-ref-gestions">Gestion stock</h4><p>RÃ©fÃ©rences de stock</p></div></div>
        <div class="tile" onclick="refsOpen('achats')"><div class="icon">ğŸ§¾</div><div><h4 id="lbl-ref-achats">Achat</h4><p>Fournisseurs/achats</p></div></div>
      </div>

      <div id="refsCat" class="hidden">
        <div class="actions-top">
          <button class="btn icon" id="refsAddBtn" title="Ajouter" onclick="refsToggleForm(true)">â•</button>
          <button class="btn icon" id="refsEditBtn" title="Mode Ã©dition" onclick="toggleRefsHint()">âœï¸</button>
        </div>

        <h3 id="refsCatTitle" style="margin-top:0">CatÃ©gorie</h3>
        <div id="refsHint" class="hint hidden">Ø§Ø³ØªØ¹Ù…Ù„ âœï¸ Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù†ØµØ± Ùˆ ğŸ—‘ï¸ Ù„Ù„Ø­Ø°Ù.</div>

        <div id="refsAddForm" class="row hidden" style="margin-top:12px">
          <input id="refsInput" class="input" placeholder="Nom Ã  ajouter">
          <button class="btn" onclick="refsAdd()">Confirmer</button>
          <button class="btn danger" onclick="refsToggleForm(false)">Annuler</button>
        </div>

        <div id="refsList" class="list" style="margin-top:14px"></div>
      </div>
    </section>

    <!-- NEW PAGE: RÃ©glages app -->
    <section id="page-appcfg" class="card hidden">
      <h2>RÃ©glages de lâ€™application</h2>
      <p class="muted">ØºÙŠÙ‘Ø± Ø§Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØªØ³Ù…ÙŠØ§Øª Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…. ÙƒÙŠØªØ­ÙØ¸Ùˆ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙˆÙŠÙ…ÙƒÙ† ØªØ±Ø¬Ø¹ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ.</p>

      <div class="sectionTitle">GÃ©nÃ©ral</div>
      <div class="grid">
        <div>
          <label class="label">Nom de lâ€™application</label>
          <input id="cfg-appTitle" class="input" placeholder="AB AGRIWEB">
        </div>
      </div>

      <div class="sectionTitle">Sidebar</div>
      <div class="grid">
        <div><label class="label">Accueil</label><input id="cfg-nav-home" class="input" placeholder="Accueil"></div>
        <div><label class="label">Irrigation</label><input id="cfg-nav-irrig" class="input" placeholder="Irrigation"></div>
        <div><label class="label">Traitement</label><input id="cfg-nav-trait" class="input" placeholder="Traitement"></div>
        <div><label class="label">ParamÃ¨tres</label><input id="cfg-nav-settings" class="input" placeholder="ParamÃ¨tres"></div>
        <div><label class="label">Logout</label><input id="cfg-nav-logout" class="input" placeholder="Logout"></div>
      </div>

      <div class="sectionTitle">Tuiles ParamÃ¨tres</div>
      <div class="grid">
        <div><label class="label">OpÃ©rateur</label><input id="cfg-tile-operators" class="input" placeholder="OPÃ‰RATEUR"></div>
        <div><label class="label">Profile</label><input id="cfg-tile-profiles" class="input" placeholder="PROFILE"></div>
        <div><label class="label">RÃ©fÃ©rentiels</label><input id="cfg-tile-refs" class="input" placeholder="RÃ‰FÃ‰RENTIELS"></div>
        <div><label class="label">Droits accÃ¨s</label><input id="cfg-tile-rights" class="input" placeholder="DROITS ACCÃˆS"></div>
        <div><label class="label">Mot de passe</label><input id="cfg-tile-pass" class="input" placeholder="MOT DE PASSE"></div>
      </div>

      <div class="sectionTitle">LibellÃ©s RÃ©fÃ©rentiels</div>
      <div class="grid">
        <div><label class="label">Ferme</label><input id="cfg-ref-ferme" class="input" placeholder="Ferme"></div>
        <div><label class="label">SociÃ©tÃ©</label><input id="cfg-ref-companies" class="input" placeholder="SociÃ©tÃ©"></div>
        <div><label class="label">Responsable</label><input id="cfg-ref-responsables" class="input" placeholder="Responsable"></div>
        <div><label class="label">Station</label><input id="cfg-ref-stations" class="input" placeholder="Station"></div>
        <div><label class="label">Secteur</label><input id="cfg-ref-secteurs" class="input" placeholder="Secteur"></div>
        <div><label class="label">Parcelle</label><input id="cfg-ref-parcelles" class="input" placeholder="Parcelle"></div>
        <div><label class="label">Transport</label><input id="cfg-ref-transports" class="input" placeholder="Transport"></div>
        <div><label class="label">VariÃ©tÃ©</label><input id="cfg-ref-varietes" class="input" placeholder="VariÃ©tÃ©"></div>
        <div><label class="label">VariÃ©tÃ© champ</label><input id="cfg-ref-varietes_champ" class="input" placeholder="VariÃ©tÃ© champ"></div>
        <div><label class="label">Gestion stock</label><input id="cfg-ref-gestions" class="input" placeholder="Gestion stock"></div>
        <div><label class="label">Achat</label><input id="cfg-ref-achats" class="input" placeholder="Achat"></div>
      </div>

      <div class="row" style="margin-top:14px">
        <button class="btn" onclick="appcfgSave()">Enregistrer</button>
        <button class="btn danger" onclick="appcfgReset()">Reset (dÃ©faut)</button>
      </div>
    </section>
  </main>

  <!-- MODALS -->
  <div id="opModal" class="modal-wrap">
    <div class="modal-bg" onclick="opCloseModal()"></div>
    <div class="modal">
      <h3>Modifier lâ€™opÃ©rateur</h3>
      <div class="row">
        <input id="edit_username" class="input" placeholder="Nom dâ€™utilisateur">
        <input id="edit_password" type="password" class="input" placeholder="Mot de passe">
      </div>
      <div class="row">
        <select id="edit_profile" class="input"></select>
        <div class="combo" id="combo-edit-ferme" style="max-width:360px; width:100%">
          <input id="edit_ferme_input" class="input" placeholder="Chercher/choisir une ferme...">
          <div id="edit_ferme_list" class="combo-list hidden"></div>
          <input type="hidden" id="edit_ferme" />
        </div>
      </div>
      <div class="right" style="margin-top:8px">
        <button class="btn danger" onclick="opCloseModal()">Annuler</button>
        <button class="btn" onclick="opSaveEdit()">Enregistrer</button>
      </div>
    </div>
  </div>

  <div id="farmModal" class="modal-wrap">
    <div class="modal-bg" onclick="farmCloseModal()"></div>
    <div class="modal">
      <h3>Modifier la ferme</h3>
      <div class="row">
        <input id="edit_farm_name" class="input" placeholder="Nom de la ferme">
        <input id="edit_farm_area" class="input" placeholder="Surface">
      </div>
      <div class="row">
        <input id="edit_farm_company" class="input" placeholder="SociÃ©tÃ©">
        <input id="edit_farm_location" class="input" placeholder="Emplacement">
      </div>
      <div class="row">
        <input id="edit_farm_manager" class="input" placeholder="Responsable">
        <input id="edit_farm_phone" class="input" placeholder="TÃ©lÃ©phone">
      </div>
      <div class="right" style="margin-top:8px">
        <button class="btn danger" onclick="farmCloseModal()">Annuler</button>
        <button class="btn" onclick="farmSaveEdit()">Enregistrer</button>
      </div>
    </div>
  </div>

<script>
  /* ---------- Sidebar + overlay ---------- */
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('overlay');
  function openMenu(){ sidebar.classList.add('active'); overlay.classList.add('active'); }
  function closeMenu(){ sidebar.classList.remove('active'); overlay.classList.remove('active'); }
  function toggleMenu(){ sidebar.classList.contains('active') ? closeMenu() : openMenu(); }
  document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeMenu(); });
  overlay.addEventListener('click', closeMenu);

  /* ---------- Routing ---------- */
  const navHome=document.getElementById('nav-home');
  const navSet=document.getElementById('nav-settings');
  const pageHome=document.getElementById('page-home');
  const pageSet=document.getElementById('page-settings');
  const pageProf=document.getElementById('page-profiles');
  const pageOps=document.getElementById('page-operators');
  const pageFarms=document.getElementById('page-farms');
  const pageRefs=document.getElementById('page-refs');
  const pageAppCfg=document.getElementById('page-appcfg');

  function setActiveLink(link){ document.querySelectorAll('.sidebar a').forEach(a=>a.classList.remove('active')); link.classList.add('active'); }
  function showPage(name){
    [pageHome,pageSet,pageProf,pageOps,pageFarms,pageRefs,pageAppCfg].forEach(p=>p.classList.add('hidden'));
    if(name==='home') pageHome.classList.remove('hidden');
    if(name==='settings') pageSet.classList.remove('hidden');
    if(name==='profiles') pageProf.classList.remove('hidden');
    if(name==='operators') pageOps.classList.remove('hidden');
    if(name==='farms') pageFarms.classList.remove('hidden');
    if(name==='refs') pageRefs.classList.remove('hidden');
    if(name==='appcfg') pageAppCfg.classList.remove('hidden');
    closeMenu();
  }
  navHome.addEventListener('click',e=>{e.preventDefault();setActiveLink(navHome);showPage('home');});
  navSet.addEventListener('click',e=>{e.preventDefault();setActiveLink(navSet);showPage('settings');});
  document.getElementById('logout').addEventListener('click',e=>{e.preventDefault();window.location='index.html';});
  function setActiveTile(){setActiveLink(navSet);} // Ù†Ø¨Ù‚Ù‰ Ø¯Ø§Ø®Ù„ ParamÃ¨tres

  /* ---------- Storage helpers ---------- */
  const LS_PROFILES='ab_profiles', LS_FARMS='ab_farms', LS_OPERATORS='ab_operators', LS_REFS='ab_refs', LS_APP='ab_appcfg';
  const DEFAULT_PROFILES=["Admin","Magasinier","Pointeur","Directeur"];
  function g(id){ return document.getElementById(id); }
  function v(id){ return g(id).value.trim(); }
  function s(id,val){ g(id).value=val; }
  function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

  /* ---------- App Config (labels) ---------- */
  const APP_DEFAULT = {
    appTitle: "AB AGRIWEB",
    nav: { home:"Accueil", irrig:"Irrigation", trait:"Traitement", settings:"ParamÃ¨tres", logout:"Logout" },
    tiles: { operators:"OPÃ‰RATEUR", profiles:"PROFILE", refs:"RÃ‰FÃ‰RENTIELS", rights:"DROITS ACCÃˆS", pass:"MOT DE PASSE", appcfg:"RÃ‰GLAGES APP" },
    refLabels: {
      ferme:"Ferme", companies:"SociÃ©tÃ©", responsables:"Responsable", stations:"Station", secteurs:"Secteur",
      parcelles:"Parcelle", transports:"Transport", varietes:"VariÃ©tÃ©", varietes_champ:"VariÃ©tÃ© champ",
      gestions:"Gestion stock", achats:"Achat"
    }
  };
  function appcfgLoad(){ try{ return Object.assign({}, APP_DEFAULT, JSON.parse(localStorage.getItem(LS_APP)||'{}')); }catch{ return {...APP_DEFAULT}; } }
  function appcfgSaveToLS(obj){ localStorage.setItem(LS_APP, JSON.stringify(obj)); }
  function appcfgReset(){ appcfgSaveToLS(APP_DEFAULT); appcfgApply(); appcfgFillForm(); alert('Ø±Ø¬Ø¹Ù†Ø§ Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©.'); }

  function appcfgApply(){
    const cfg = appcfgLoad();
    // Title
    document.title = cfg.appTitle + ' - Dashboard';
    g('appTitleTop').textContent = cfg.appTitle;

    // Sidebar labels
    g('lbl-nav-home').textContent = 'ğŸ  ' + cfg.nav.home;
    g('lbl-nav-irrig').textContent = 'ğŸŒ¿ ' + cfg.nav.irrig;
    g('lbl-nav-trait').textContent = 'ğŸ’§ ' + cfg.nav.trait;
    g('lbl-nav-settings').textContent = 'âš™ï¸ ' + cfg.nav.settings;
    g('lbl-nav-logout').textContent = 'ğŸšª ' + cfg.nav.logout;

    // Settings tiles
    g('lbl-tile-operators').textContent = cfg.tiles.operators;
    g('lbl-tile-profiles').textContent = cfg.tiles.profiles;
    g('lbl-tile-refs').textContent = cfg.tiles.refs;
    g('lbl-tile-rights').textContent = cfg.tiles.rights;
    g('lbl-tile-pass').textContent   = cfg.tiles.pass;
    g('lbl-tile-appcfg').textContent = cfg.tiles.appcfg;

    // RÃ©fÃ©rentiels labels (home tiles)
    g('lbl-ref-ferme').textContent = cfg.refLabels.ferme;
    g('lbl-ref-companies').textContent = cfg.refLabels.companies;
    g('lbl-ref-responsables').textContent = cfg.refLabels.responsables;
    g('lbl-ref-stations').textContent = cfg.refLabels.stations;
    g('lbl-ref-secteurs').textContent = cfg.refLabels.secteurs;
    g('lbl-ref-parcelles').textContent = cfg.refLabels.parcelles;
    g('lbl-ref-transports').textContent = cfg.refLabels.transports;
    g('lbl-ref-varietes').textContent = cfg.refLabels.varietes;
    g('lbl-ref-varietes_champ').textContent = cfg.refLabels.varietes_champ;
    g('lbl-ref-gestions').textContent = cfg.refLabels.gestions;
    g('lbl-ref-achats').textContent = cfg.refLabels.achats;

    // Update mapping object used inside refsCat title
    Object.assign(REF_LABELS, cfg.refLabels);
  }

  function appcfgFillForm(){
    const c = appcfgLoad();
    s('cfg-appTitle', c.appTitle);

    s('cfg-nav-home', c.nav.home);
    s('cfg-nav-irrig', c.nav.irrig);
    s('cfg-nav-trait', c.nav.trait);
    s('cfg-nav-settings', c.nav.settings);
    s('cfg-nav-logout', c.nav.logout);

    s('cfg-tile-operators', c.tiles.operators);
    s('cfg-tile-profiles', c.tiles.profiles);
    s('cfg-tile-refs', c.tiles.refs);
    s('cfg-tile-rights', c.tiles.rights);
    s('cfg-tile-pass', c.tiles.pass);

    s('cfg-ref-ferme', c.refLabels.ferme);
    s('cfg-ref-companies', c.refLabels.companies);
    s('cfg-ref-responsables', c.refLabels.responsables);
    s('cfg-ref-stations', c.refLabels.stations);
    s('cfg-ref-secteurs', c.refLabels.secteurs);
    s('cfg-ref-parcelles', c.refLabels.parcelles);
    s('cfg-ref-transports', c.refLabels.transports);
    s('cfg-ref-varietes', c.refLabels.varietes);
    s('cfg-ref-varietes_champ', c.refLabels.varietes_champ);
    s('cfg-ref-gestions', c.refLabels.gestions);
    s('cfg-ref-achats', c.refLabels.achats);
  }

  function appcfgSave(){
    const obj = appcfgLoad();
    obj.appTitle = v('cfg-appTitle') || APP_DEFAULT.appTitle;
    obj.nav.home = v('cfg-nav-home') || APP_DEFAULT.nav.home;
    obj.nav.irrig = v('cfg-nav-irrig') || APP_DEFAULT.nav.irrig;
    obj.nav.trait = v('cfg-nav-trait') || APP_DEFAULT.nav.trait;
    obj.nav.settings = v('cfg-nav-settings') || APP_DEFAULT.nav.settings;
    obj.nav.logout = v('cfg-nav-logout') || APP_DEFAULT.nav.logout;

    obj.tiles.operators = v('cfg-tile-operators') || APP_DEFAULT.tiles.operators;
    obj.tiles.profiles  = v('cfg-tile-profiles')  || APP_DEFAULT.tiles.profiles;
    obj.tiles.refs      = v('cfg-tile-refs')      || APP_DEFAULT.tiles.refs;
    obj.tiles.rights    = v('cfg-tile-rights')    || APP_DEFAULT.tiles.rights;
    obj.tiles.pass      = v('cfg-tile-pass')      || APP_DEFAULT.tiles.pass;

    obj.refLabels.ferme = v('cfg-ref-ferme') || APP_DEFAULT.refLabels.ferme;
    obj.refLabels.companies = v('cfg-ref-companies') || APP_DEFAULT.refLabels.companies;
    obj.refLabels.responsables = v('cfg-ref-responsables') || APP_DEFAULT.refLabels.responsables;
    obj.refLabels.stations = v('cfg-ref-stations') || APP_DEFAULT.refLabels.stations;
    obj.refLabels.secteurs = v('cfg-ref-secteurs') || APP_DEFAULT.refLabels.secteurs;
    obj.refLabels.parcelles = v('cfg-ref-parcelles') || APP_DEFAULT.refLabels.parcelles;
    obj.refLabels.transports = v('cfg-ref-transports') || APP_DEFAULT.refLabels.transports;
    obj.refLabels.varietes = v('cfg-ref-varietes') || APP_DEFAULT.refLabels.varietes;
    obj.refLabels.varietes_champ = v('cfg-ref-varietes_champ') || APP_DEFAULT.refLabels.varietes_champ;
    obj.refLabels.gestions = v('cfg-ref-gestions') || APP_DEFAULT.refLabels.gestions;
    obj.refLabels.achats = v('cfg-ref-achats') || APP_DEFAULT.refLabels.achats;

    appcfgSaveToLS(obj);
    appcfgApply();
    alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…');
  }

  /* ---------- Profiles ---------- */
  function loadProfiles(){ try{return JSON.parse(localStorage.getItem(LS_PROFILES))||[];}catch{return [];} }
  function saveProfiles(a){ localStorage.setItem(LS_PROFILES, JSON.stringify(a)); }
  function renderProfiles(){
    const list=g('profilesList'); if(!list) return;
    const data=loadProfiles();
    if(data.length===0){list.innerHTML='<div class="item"><span class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø±ÙˆÙØ§ÙŠÙ„Ø§Øª Ø¨Ø¹Ø¯.</span></div>';return;}
    list.innerHTML=data.map((n,i)=>`
      <div class="item">
        <div class="meta"><b>${escapeHtml(n)}</b></div>
        <div class="actions">
          <button class="btn icon" onclick="profileEdit(${i})">âœï¸</button>
          <button class="btn danger icon" onclick="removeProfile(${i})">ğŸ—‘ï¸</button>
        </div>
      </div>`).join('');
  }
  function profileEdit(i){
    const data=loadProfiles(); const old=data[i];
    const nv=prompt('Modifier le profil:', old);
    if(nv===null) return;
    const val=nv.trim(); if(!val){ alert('Nom vide.'); return; }
    if(val.toLowerCase()!==old.toLowerCase() && data.some(x=>x.toLowerCase()===val.toLowerCase())){ alert('Existe dÃ©jÃ .'); return; }
    data[i]=val; saveProfiles(data); renderProfiles(); opRefreshProfileSelects();
  }
  function addProfile(){
    const name=v('profileName'); if(!name){alert('Entrer un nom de profil.');return;}
    const data=loadProfiles();
    if(data.some(x=>x.toLowerCase()===name.toLowerCase())){alert('Ce profil existe dÃ©jÃ .');return;}
    data.push(name); saveProfiles(data); s('profileName',''); toggleAddForm(false); renderProfiles(); opRefreshProfileSelects();
  }
  function removeProfile(i){
    const data=loadProfiles(); if(!confirm('Supprimer le profil : '+data[i]+' ?'))return;
    data.splice(i,1); saveProfiles(data); renderProfiles(); opRefreshProfileSelects();
  }
  function toggleAddForm(show){
    const form=g('addForm');
    if(show){form.classList.remove('hidden'); g('profileName').focus();}
    else{form.classList.add('hidden');}
  }
  function showProfilesHint(){ g('profilesHint').classList.toggle('hidden'); }

  /* ---------- Farms ---------- */
  function loadFarms(){ try{return JSON.parse(localStorage.getItem(LS_FARMS))||[];}catch{return [];} }
  function saveFarms(a){ localStorage.setItem(LS_FARMS, JSON.stringify(a)); }
  function farmToggleForm(show){ const f=g('farmAddForm'); if(show){f.classList.remove('hidden');g('farm_name').focus();} else {f.classList.add('hidden');} }
  function farmAdd(){
    const obj={ name:v('farm_name'), area:v('farm_area'), company:v('farm_company'), location:v('farm_location'), manager:v('farm_manager'), phone:v('farm_phone') };
    if(!obj.name){ alert('Nom de la ferme requis.'); return; }
    const d=loadFarms(); if(d.some(x=>x.name.toLowerCase()===obj.name.toLowerCase())){ alert('Cette ferme existe dÃ©jÃ .'); return; }
    d.push(obj); saveFarms(d); farmToggleForm(false); renderFarms(); opRefreshFarmCombos();
  }
  function renderFarms(){
    const wrap=g('farmsList'); if(!wrap) return;
    const d=loadFarms();
    if(d.length===0){ wrap.innerHTML='<div class="item"><span class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¶ÙŠØ¹Ø§Øª Ø¨Ø¹Ø¯.</span></div>'; return; }
    wrap.innerHTML = d.map((f,i)=>`
      <div class="item">
        <div class="meta">
          <span><b>Ferme:</b> ${escapeHtml(f.name)}</span>
          <span><b>Surface:</b> ${escapeHtml(f.area||'')}</span>
          <span><b>SociÃ©tÃ©:</b> ${escapeHtml(f.company||'')}</span>
          <span><b>Lieu:</b> ${escapeHtml(f.location||'')}</span>
          <span><b>Resp.:</b> ${escapeHtml(f.manager||'')}</span>
          <span><b>TÃ©l:</b> ${escapeHtml(f.phone||'')}</span>
        </div>
        <div class="actions">
          <button class="btn icon" onclick="farmEdit(${i})">âœï¸</button>
          <button class="btn danger icon" onclick="farmDelete(${i})">ğŸ—‘ï¸</button>
        </div>
      </div>
    `).join('');
  }
  let farmEditIndex=null;
  function farmEdit(i){
    const f=loadFarms()[i]; farmEditIndex=i;
    s('edit_farm_name',f.name||''); s('edit_farm_area',f.area||''); s('edit_farm_company',f.company||'');
    s('edit_farm_location',f.location||''); s('edit_farm_manager',f.manager||''); s('edit_farm_phone',f.phone||'');
    farmOpenModal();
  }
  function farmOpenModal(){ g('farmModal').classList.add('show'); }
  function farmCloseModal(){ g('farmModal').classList.remove('show'); farmEditIndex=null; }
  function farmSaveEdit(){
    if(farmEditIndex===null) return;
    const d=loadFarms(), vobj={ name:v('edit_farm_name'), area:v('edit_farm_area'), company:v('edit_farm_company'), location:v('edit_farm_location'), manager:v('edit_farm_manager'), phone:v('edit_farm_phone') };
    if(!vobj.name){ alert('Nom de la ferme requis.'); return; }
    if(vobj.name.toLowerCase()!==d[farmEditIndex].name.toLowerCase() && d.some(x=>x.name.toLowerCase()===vobj.name.toLowerCase())){ alert('Nom de ferme dÃ©jÃ  utilisÃ©.'); return; }
    d[farmEditIndex]=vobj; saveFarms(d); farmCloseModal(); renderFarms(); opRefreshFarmCombos();
  }
  function farmDelete(i){ const d=loadFarms(); if(!confirm('Supprimer la ferme: '+d[i].name+' ?')) return; d.splice(i,1); saveFarms(d); renderFarms(); opRefreshFarmCombos(); }
  function showFarmsHint(){ g('farmsHint').classList.toggle('hidden'); }

  /* ---------- Operators ---------- */
  function loadOps(){ try{return JSON.parse(localStorage.getItem(LS_OPERATORS))||[];}catch{return [];} }
  function saveOps(a){ localStorage.setItem(LS_OPERATORS, JSON.stringify(a)); }
  function opToggleForm(show){ const f=g('opAddForm'); if(show){f.classList.remove('hidden'); g('op_username').focus(); opRefreshProfileSelects(); opRefreshFarmCombos();} else {f.classList.add('hidden');} }
  function opBuildProfileOptions(id){ const sel=g(id); if(!sel) return; const p=loadProfiles(); sel.innerHTML=p.length?p.map(x=>`<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join(''):`<option value="">(Aucun profil)</option>`; }
  function opRefreshProfileSelects(){ opBuildProfileOptions('op_profile'); opBuildProfileOptions('edit_profile'); }
  function comboFill(idBase, items){
    const input=g(idBase+'_input'), list=g(idBase+'_list'), hidden=g(idBase);
    function render(q=''){ const m=items.filter(x=>x.toLowerCase().includes(q.toLowerCase())); list.innerHTML=m.length? m.map(v=>`<div class="combo-item" data-v="${escapeHtml(v)}">${escapeHtml(v)}</div>`).join('') : `<div class="combo-item muted">(aucun rÃ©sultat)</div>`; }
    render(); input.oninput=()=>render(input.value); input.onfocus=()=>{list.classList.remove('hidden');render(input.value);};
    document.addEventListener('click',e=>{ if(!list.contains(e.target)&&e.target!==input) list.classList.add('hidden');});
    list.onclick=e=>{ const el=e.target.closest('.combo-item'); if(!el) return; const v=el.getAttribute('data-v'); input.value=v; hidden.value=v; list.classList.add('hidden'); };
  }
  function opRefreshFarmCombos(){ const farms=loadFarms().map(f=>f.name); comboFill('op_ferme',farms); comboFill('edit_ferme',farms); }
  function renderOps(){
    const w=g('operatorsList'); if(!w) return; const d=loadOps();
    if(d.length===0){
      w.innerHTML='<div class="item"><span class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¯.</span></div>'; return;
    }
    w.innerHTML=d.map((u,i)=>`
      <div class="item">
        <div class="meta">
          <span><b>Utilisateur:</b> ${escapeHtml(u.username)}</span>
          <span><b>Profil:</b> ${escapeHtml(u.profile||'')}</span>
          <span><b>Ferme:</b> ${escapeHtml(u.ferme||'')}</span>
        </div>
        <div class="actions">
          <button class="btn icon" onclick="opEdit(${i})">âœï¸</button>
          <button class="btn danger icon" onclick="opDelete(${i})">ğŸ—‘ï¸</button>
        </div>
      </div>
    `).join('');
  }
  let editIndex=null;
  function opOpenModal(){ g('opModal').classList.add('show'); }
  function opCloseModal(){ g('opModal').classList.remove('show'); editIndex=null; }
  function opEdit(i){ const d=loadOps(), u=d[i]; editIndex=i; s('edit_username',u.username); s('edit_password',u.password); opRefreshProfileSelects(); g('edit_profile').value=u.profile||''; const farms=loadFarms().map(f=>f.name); comboFill('edit_ferme',farms); s('edit_ferme_input',u.ferme||''); s('edit_ferme',u.ferme||''); opOpenModal(); }
  function opSaveEdit(){
    if(editIndex===null) return;
    const d=loadOps(), u=d[editIndex];
    const nu=v('edit_username'), np=v('edit_password'), npr=g('edit_profile').value.trim(), nfe=v('edit_ferme');
    if(!nu||!np||!npr||!nfe){ alert('Remplir tous les champs.'); return; }
    if(nu.toLowerCase()!==u.username.toLowerCase() && d.some(x=>x.username.toLowerCase()===nu.toLowerCase())){ alert('Nom dâ€™utilisateur dÃ©jÃ  utilisÃ©.'); return; }
    d[editIndex]={username:nu, password:np, profile:npr, ferme:nfe}; saveOps(d); opCloseModal(); renderOps();
  }
  function opAdd(){
    const username=v('op_username'), password=v('op_password'), profile=g('op_profile').value.trim(), ferme=v('op_ferme');
    if(!username||!password||!profile||!ferme){ alert('Remplir tous les champs.'); return; }
    const d=loadOps(); if(d.some(x=>x.username.toLowerCase()===username.toLowerCase())){ alert('Cet utilisateur existe dÃ©jÃ .'); return; }
    d.push({username,password,profile,ferme}); saveOps(d); s('op_username',''); s('op_password',''); s('op_ferme_input',''); s('op_ferme',''); opToggleForm(false); renderOps();
  }
  function opDelete(i){ const d=loadOps(); if(!confirm('Supprimer lâ€™utilisateur: '+d[i].username+' ?')) return; d.splice(i,1); saveOps(d); renderOps(); }
  function showOpsHint(){ g('opsHint').classList.toggle('hidden'); }

  /* ---------- RÃ©fÃ©rentiels (engine) ---------- */
  const LS_REFS_KEYS_DEFAULT = {
    companies:[], responsables:[], stations:[], secteurs:[],
    parcelles:[], transports:[], varietes:[], varietes_champ:[],
    gestions:[], achats:[]
  };
  const REF_LABELS = { // Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ù…Ù† appcfgApply()
    companies:"SociÃ©tÃ©", responsables:"Responsable", stations:"Station", secteurs:"Secteur",
    parcelles:"Parcelle", transports:"Transport", varietes:"VariÃ©tÃ©", varietes_champ:"VariÃ©tÃ© champ",
    gestions:"Gestion stock", achats:"Achat"
  };
  let currentRefKey=null;

  function loadRefs(){ try{ return Object.assign({}, LS_REFS_KEYS_DEFAULT, JSON.parse(localStorage.getItem(LS_REFS)||'{}')); }catch{ return {...LS_REFS_KEYS_DEFAULT}; } }
  function saveRefs(obj){ localStorage.setItem(LS_REFS, JSON.stringify(obj)); }

  function refsOpen(key){
    currentRefKey=key;
    g('refsHome').classList.add('hidden');
    g('refsCat').classList.remove('hidden');
    g('refsCatTitle').textContent = REF_LABELS[key] || 'CatÃ©gorie';
    g('refsHint').classList.add('hidden');
    refsToggleForm(false);
    refsRender();
  }
  function refsToggleForm(show){
    const f=g('refsAddForm');
    if(show){ f.classList.remove('hidden'); g('refsInput').focus(); }
    else{ f.classList.add('hidden'); s('refsInput',''); }
  }
  function toggleRefsHint(){ g('refsHint').classList.toggle('hidden'); }

  function refsRender(){
    const wrap=g('refsList'); const data=(loadRefs()[currentRefKey]||[]);
    if(data.length===0){ wrap.innerHTML='<div class="item"><span class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ø¨Ø¹Ø¯.</span></div>'; return; }
    wrap.innerHTML=data.map((name,idx)=>`
      <div class="item">
        <div class="meta"><span><b>${escapeHtml(name)}</b></span></div>
        <div class="actions">
          <button class="btn icon" onclick="refsEdit(${idx})">âœï¸</button>
          <button class="btn danger icon" onclick="refsDelete(${idx})">ğŸ—‘ï¸</button>
        </div>
      </div>
    `).join('');
  }
  function refsAdd(){
    const name=v('refsInput'); if(!name){ alert('Nom requis.'); return; }
    const refs=loadRefs(); const arr=refs[currentRefKey]||[];
    if(arr.some(x=>x.toLowerCase()===name.toLowerCase())){ alert('Existe dÃ©jÃ .'); return; }
    arr.push(name); refs[currentRefKey]=arr; saveRefs(refs); refsToggleForm(false); refsRender();
  }
  function refsEdit(idx){
    const refs=loadRefs(); const arr=refs[currentRefKey]||[]; const old=arr[idx];
    const nv=prompt('Modifier:', old);
    if(nv===null) return;
    const val=nv.trim(); if(!val){ alert('Nom vide.'); return; }
    if(val.toLowerCase()!==old.toLowerCase() && arr.some(x=>x.toLowerCase()===val.toLowerCase())){ alert('Existe dÃ©jÃ .'); return; }
    arr[idx]=val; refs[currentRefKey]=arr; saveRefs(refs); refsRender();
  }
  function refsDelete(idx){
    const refs=loadRefs(); const arr=refs[currentRefKey]||[]; if(!confirm('Supprimer: '+arr[idx]+' ?')) return;
    arr.splice(idx,1); refs[currentRefKey]=arr; saveRefs(refs); refsRender();
  }

  /* ---------- INIT ---------- */
  (function init(){
    if(!localStorage.getItem(LS_PROFILES)) saveProfiles(DEFAULT_PROFILES.slice());
    saveRefs(loadRefs()); // ensure refs obj exists
    appcfgApply();        // Ø·Ø¨Ù‘Ù‚ ØªØ³Ù…ÙŠØ§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    appcfgFillForm();     // Ø¹Ø¨Ù‘ÙŠ ÙÙˆØ±Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    renderProfiles();
    renderFarms();
    renderOps();
  })();

  /* helpers after init */
  function opRefreshProfileSelects(){ 
    const sel=g('op_profile'); if(sel){ const p=loadProfiles(); sel.innerHTML=p.length?p.map(x=>`<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join(''):`<option value="">(Aucun profil)</option>`; }
    const sel2=g('edit_profile'); if(sel2){ const p=loadProfiles(); sel2.innerHTML=p.length?p.map(x=>`<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join(''):`<option value="">(Aucun profil)</option>`; }
  }
  function opRefreshFarmCombos(){
    const farms=loadFarms().map(f=>f.name);
    comboFill('op_ferme',farms);
    comboFill('edit_ferme',farms);
  }
</script>

</body>
</html>
